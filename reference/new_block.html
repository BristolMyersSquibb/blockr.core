<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Blocks — new_block • blockr.core</title><script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Blocks — new_block"><meta name="description" content="Steps in a data analysis pipeline are represented by blocks. Each block
combines data input with user inputs to produce an output. In order to
create a block, which is implemented as a shiny module, we require a server
function, a function that produces some UI and a class vector."><meta property="og:description" content="Steps in a data analysis pipeline are represented by blocks. Each block
combines data input with user inputs to produce an output. In order to
create a block, which is implemented as a shiny module, we require a server
function, a function that produces some UI and a class vector."><script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/11.5.0/mermaid.min.js" integrity="sha512-3EZqKCkk3nMLmbrI7mfry81KH7dkzy/BoDfQrodwLQnS/RbsVlERdYP6J0oiJegRUxSOmx7Y35WNbVKSw7mipw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">blockr.core</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/get-started.html">Get started</a></li>
    <li><a class="dropdown-item" href="../articles/create-block.html">Create a block</a></li>
    <li><a class="dropdown-item" href="../articles/blocks-registry.html">Browse for blocks</a></li>
    <li><a class="dropdown-item" href="../articles/extend-blockr.html">Extend blockr</a></li>
    <li><a class="dropdown-item" href="../articles/testing-blocks.html">Testing blocks</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/BristolMyersSquibb/blockr.core/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch"><li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Blocks</h1>
      <small class="dont-index">Source: <a href="https://github.com/BristolMyersSquibb/blockr.core/blob/main/R/block-class.R" class="external-link"><code>R/block-class.R</code></a>, <a href="https://github.com/BristolMyersSquibb/blockr.core/blob/main/R/blocks-class.R" class="external-link"><code>R/blocks-class.R</code></a></small>
      <div class="d-none name"><code>new_block.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Steps in a data analysis pipeline are represented by blocks. Each block
combines data input with user inputs to produce an output. In order to
create a block, which is implemented as a shiny module, we require a server
function, a function that produces some UI and a class vector.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">new_block</span><span class="op">(</span></span>
<span>  <span class="va">server</span>,</span>
<span>  <span class="va">ui</span>,</span>
<span>  <span class="va">class</span>,</span>
<span>  <span class="va">ctor</span>,</span>
<span>  <span class="va">ctor_pkg</span>,</span>
<span>  dat_valid <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  allow_empty_state <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  name <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  <span class="va">...</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">is_block</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">as_block</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">blocks</span><span class="op">(</span><span class="va">...</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">is_blocks</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">as_blocks</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-server">server<a class="anchor" aria-label="anchor" href="#arg-server"></a></dt>
<dd><p>A function returning <code><a href="https://rdrr.io/pkg/shiny/man/moduleServer.html" class="external-link">shiny::moduleServer()</a></code></p></dd>


<dt id="arg-ui">ui<a class="anchor" aria-label="anchor" href="#arg-ui"></a></dt>
<dd><p>A function with a single argument (<code>ns</code>) returning a <code>shiny.tag</code></p></dd>


<dt id="arg-class">class<a class="anchor" aria-label="anchor" href="#arg-class"></a></dt>
<dd><p>Block subclass</p></dd>


<dt id="arg-ctor">ctor<a class="anchor" aria-label="anchor" href="#arg-ctor"></a></dt>
<dd><p>String-valued constructor name or function/frame number (mostly
for internal use or when defining constructors for virtual classes)</p></dd>


<dt id="arg-ctor-pkg">ctor_pkg<a class="anchor" aria-label="anchor" href="#arg-ctor-pkg"></a></dt>
<dd><p>String-valued package name when passing a string-valued
constructor name or <code>NULL</code></p></dd>


<dt id="arg-dat-valid">dat_valid<a class="anchor" aria-label="anchor" href="#arg-dat-valid"></a></dt>
<dd><p>(Optional) input data validator</p></dd>


<dt id="arg-allow-empty-state">allow_empty_state<a class="anchor" aria-label="anchor" href="#arg-allow-empty-state"></a></dt>
<dd><p>Either <code>TRUE</code>, <code>FALSE</code> or a character vector of
<code>state</code> values that may be empty while still moving forward with block eval</p></dd>


<dt id="arg-name">name<a class="anchor" aria-label="anchor" href="#arg-name"></a></dt>
<dd><p>Block name</p></dd>


<dt id="arg--">...<a class="anchor" aria-label="anchor" href="#arg--"></a></dt>
<dd><p>Further (metadata) attributes</p></dd>


<dt id="arg-x">x<a class="anchor" aria-label="anchor" href="#arg-x"></a></dt>
<dd><p>An object inheriting from <code>"block"</code></p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>Both <code>new_block()</code> and <code>as_block()</code> return an object inheriting from
<code>block</code>, while <code>is_block()</code> returns a boolean indicating whether an object
inherits from <code>block</code> or not. Block vectors, created using <code>blocks()</code>,
<code>as_blocks()</code>, or by combining multiple blocks using <code><a href="https://rdrr.io/r/base/c.html" class="external-link">base::c()</a></code> all inherit
frm <code>blocks</code> and <code>iss_block()</code> returns a boolean indicating whether an object
inherits from <code>blocks</code> or not.</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>A block constructor may have arguments, which taken together define the
block state. It is good practice to expose all user-selectable arguments of
a block (i.e. everything excluding the "data" input) as block arguments such
that block can be fully initialized via the constructor. Some default values
are required such that blocks can be constructed via constructor calls
without arguments. Where it is sensible to do so, specific default values
are acceptable, but if in any way data dependent, defaults should map to
an "empty" input. For example, a block that provides <code><a href="https://rdrr.io/r/utils/head.html" class="external-link">utils::head()</a></code>
functionality, one such argument could be <code>n</code> and a reasonable default value
could be <code>6L</code> (in line with corresponding default S3 method implementation).
On the other hand, a block that performs a <code><a href="https://rdrr.io/r/base/merge.html" class="external-link">base::merge()</a></code> operation might
expose a <code>by</code> argument, but a general purpose default value (that does not
depend on the data) is not possible. Therefore, <code><a href="new_transform_block.html">new_merge_block()</a></code> has
<code>by = character()</code>.</p>
<p>The return value of a block constructor should be the result of a call to
<code>new_block()</code> and <code>...</code> should be contained in the constructor signature
such that general block arguments (e.g. <code>name</code>) are available from the
constructor.</p>
    </div>
    <div class="section level2">
    <h2 id="server">Server<a class="anchor" aria-label="anchor" href="#server"></a></h2>


<p>The server function (passed as <code>server</code>) is expected to be a function that
returns a <code><a href="https://rdrr.io/pkg/shiny/man/moduleServer.html" class="external-link">shiny::moduleServer()</a></code>. This function is expected to have at
least an argument <code>id</code> (string-valued), which will be used as the module ID.
Further arguments may be used in the function signature, one for each "data"
input. A block implementing <code><a href="https://rdrr.io/r/utils/head.html" class="external-link">utils::head()</a></code> for example could have a single
extra argument <code>data</code>, while a block that performs <code><a href="https://rdrr.io/r/base/merge.html" class="external-link">base::merge()</a></code> requires
two extra arguments, e.g. <code>x</code> and <code>y</code>. Finally, a variadic block, e.g.
a block implementing something like <code><a href="https://rdrr.io/r/base/cbind.html" class="external-link">base::rbind()</a></code>, needs to accommodate for
an arbitrary number of inputs. This is achieved by passing a
<code><a href="https://rdrr.io/pkg/shiny/man/reactiveValues.html" class="external-link">shiny::reactiveValues()</a></code> object as <code>...args</code> and thus such a variadic block
needs <code>...args</code> as part of the server function signature. All per-data input
arguments are passed as <code><a href="https://rdrr.io/pkg/shiny/man/reactive.html" class="external-link">shiny::reactive()</a></code> or <code><a href="https://rdrr.io/pkg/shiny/man/reactiveVal.html" class="external-link">shiny::reactiveVal()</a></code>
objects.</p>
<p>The server function may implement arbitrary shiny logic and is expected to
return a list with components <code>expr</code> and <code>state</code>. The expression corresponds
to the R code necessary to perform the block task and is expected to be
a reactive quoted expression. It should contain user-chosen values for all
user inputs and placeholders for all data inputs (using the same names for
data inputs as in the server function signature). Such an expression for a
<code><a href="https://rdrr.io/r/base/merge.html" class="external-link">base::merge()</a></code> block could be created using <code><a href="https://rdrr.io/r/base/bquote.html" class="external-link">base::bquote()</a></code> as</p>
<p></p><div class="sourceCode r"><pre><code>bquote(
  merge(x, y, by = .(cols)),
  list(cols = current_val())
}
</code></pre><p></p></div>
<p>where <code>current_val()</code> is a reactive that evaluates to the current user
selection of the <code>by</code> columns. This should then be wrapped in a
<code><a href="https://rdrr.io/pkg/shiny/man/reactive.html" class="external-link">shiny::reactive()</a></code> call such that <code>current_val()</code> can be evaluated whenever
the current expression is required.</p>
<p>The <code>state</code> component is expected to be a named list with either reactive or
"static" values. In most cases, components of <code>state</code> will be reactives,
but it might make sense in some scenarios to have constructor arguments that
are not exposed via UI components but are fixed at construction time. An
example for this could be the <code>dataset_block</code> implementation where we have
constructor arguments <code>dataset</code> and <code>package</code>, but only expose <code>dataset</code>
as UI element. This means that <code>package</code> is fixed at construction time.
Nevertheless, <code>package</code> is required as state component, as this is used for
re-creating blocks from saved state.</p>
<p>State component names are required to match block constructor arguments and
re-creating saved objects basically calls the block constructor with values
obtained from block state.</p>
    </div>
    <div class="section level2">
    <h2 id="ui">UI<a class="anchor" aria-label="anchor" href="#ui"></a></h2>


<p>Block UI is generated using the function passed as <code>ui</code> to the <code>new_block</code>
constructor. This function is required to take a single argument <code>id</code> and
shiny UI components have to be namespaced such that they are nested within
this ID (i.e. by creating IDs as <code>shiny::NS(id, "some_value")</code>). Some care
has to be taken to properly initialize inputs with constructor values. As a
rule of thumb, input elements exposed to the UI should have corresponding
block constructor arguments such that blocks can be created with a given
initial state.</p>
<p>Block UI should be limited to displaying and arranging user inputs to set
block arguments. For outputs, use generics <code><a href="block_ui.html">block_output()</a></code> and
<code><a href="block_ui.html">block_ui()</a></code>.</p>
    </div>
    <div class="section level2">
    <h2 id="sub-classing">Sub-classing<a class="anchor" aria-label="anchor" href="#sub-classing"></a></h2>


<p>In addition to the specific class of a block, the core package uses virtual
classes to group together blocks with similar behavior (e.g.
<code>transform_block</code>) and makes use of this inheritance structure in S3
dispatch for methods like <code><a href="block_ui.html">block_output()</a></code> and <code><a href="block_ui.html">block_ui()</a></code>. This pattern is
not required but encouraged.</p>
    </div>
    <div class="section level2">
    <h2 id="initialization-evaluation">Initialization/evaluation<a class="anchor" aria-label="anchor" href="#initialization-evaluation"></a></h2>


<p>Some control over when a block is considered "ready for evaluation" is
available via arguments <code>dat_valid</code> and <code>allow_empty_state</code>. Data input
validation can optionally be performed by passing a predicate function with
the same arguments as in the server function (not including <code>id</code>) and the
block expression will not be evaluated as long as this function throws an
error.</p>
<p>Other conditions (messages and warnings) may be thrown as will be caught
and displayed to the user but they will not interrupt evaluation. Errors
are safe in that they will be caught as well but the will interrupt
evaluation as long as block data input does not satisfy validation.</p>
    </div>
    <div class="section level2">
    <h2 id="block-vectors">Block vectors<a class="anchor" aria-label="anchor" href="#block-vectors"></a></h2>


<p>Multiple blocks can be combined into a <code>blocks</code> object, a container for
an (ordered) set of blocks. Block IDs are handled at the <code>blocks</code> level
which will ensure uniqueness.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="va">new_identity_block</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="new_transform_block.html">new_transform_block</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>    <span class="kw">function</span><span class="op">(</span><span class="va">id</span>, <span class="va">data</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>      <span class="fu">moduleServer</span><span class="op">(</span></span></span>
<span class="r-in"><span>        <span class="va">id</span>,</span></span>
<span class="r-in"><span>        <span class="kw">function</span><span class="op">(</span><span class="va">input</span>, <span class="va">output</span>, <span class="va">session</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>          <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>            expr <span class="op">=</span> <span class="fu">reactive</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/substitute.html" class="external-link">quote</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/identity.html" class="external-link">identity</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>            state <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-in"><span>          <span class="op">)</span></span></span>
<span class="r-in"><span>        <span class="op">}</span></span></span>
<span class="r-in"><span>      <span class="op">)</span></span></span>
<span class="r-in"><span>    <span class="op">}</span>,</span></span>
<span class="r-in"><span>    <span class="kw">function</span><span class="op">(</span><span class="va">id</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>      <span class="fu">tagList</span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-in"><span>    <span class="op">}</span>,</span></span>
<span class="r-in"><span>    class <span class="op">=</span> <span class="st">"identity_block"</span></span></span>
<span class="r-in"><span>  <span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">blk</span> <span class="op">&lt;-</span> <span class="fu">new_identity_block</span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu">is_block</span><span class="op">(</span><span class="va">blk</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] TRUE</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">blks</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>a <span class="op">=</span> <span class="fu"><a href="new_data_block.html">new_dataset_block</a></span><span class="op">(</span><span class="op">)</span>, b <span class="op">=</span> <span class="fu"><a href="new_transform_block.html">new_subset_block</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="fu">is_block</span><span class="op">(</span><span class="va">blks</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] FALSE</span>
<span class="r-in"><span><span class="fu">is_blocks</span><span class="op">(</span><span class="va">blks</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] TRUE</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">blks</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] "a" "b"</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="kw"><a href="https://rdrr.io/r/base/conditions.html" class="external-link">tryCatch</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">blks</span><span class="op">[</span><span class="st">"a"</span><span class="op">]</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"b"</span>,</span></span>
<span class="r-in"><span>  error <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/conditions.html" class="external-link">conditionMessage</a></span><span class="op">(</span><span class="va">e</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] "Replacing IDs `a` with `b` is not allowed."</span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Nicolas Bennett, David Granjon, Christoph Sax, Bristol Myers Squibb.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.2.</p>
</div>

    </footer></div>





  </body></html>

