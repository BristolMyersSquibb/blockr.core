<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>5. Testing blocks • blockr.core</title>
<script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><script src="testing-blocks_files/libs/quarto-html/popper.min.js"></script><script src="testing-blocks_files/libs/quarto-html/tippy.umd.min.js"></script><link href="testing-blocks_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="testing-blocks_files/libs/quarto-html/light-border.css" rel="stylesheet">
<!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="5. Testing blocks">
<script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/11.5.0/mermaid.min.js" integrity="sha512-3EZqKCkk3nMLmbrI7mfry81KH7dkzy/BoDfQrodwLQnS/RbsVlERdYP6J0oiJegRUxSOmx7Y35WNbVKSw7mipw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">blockr.core</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/get-started.html">Get started</a></li>
    <li><a class="dropdown-item" href="../articles/create-block.html">Create a block</a></li>
    <li><a class="dropdown-item" href="../articles/blocks-registry.html">Browse for blocks</a></li>
    <li><a class="dropdown-item" href="../articles/extend-blockr.html">Extend blockr</a></li>
    <li><a class="dropdown-item" href="../articles/testing-blocks.html">Testing blocks</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch">
<li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-quarto">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>5. Testing blocks</h1>





      <div class="d-none name"><code></code></div>
    </div>






    <p>As a block developer, you may want to write unit tests for any blocks you create. Testing blocks is more complex than writing unit tests for standard R code. For blocks, we need methods to both interact with the reactive shiny values in the blocks, and to capture the state and expressions returned by our blocks.</p>
<p>In both instances, we can take advantage of <code><a href="https://rdrr.io/pkg/shiny/man/testServer.html" class="external-link">shiny::testServer()</a></code>. This function allows us to simulate a blockr application, without having to spin up a full app (which would be time consuming to create and result in slow tests). This vignette will show how to apply <code><a href="https://rdrr.io/pkg/shiny/man/testServer.html" class="external-link">shiny::testServer()</a></code> to a suite of common test cases. For more details on how <code><a href="https://rdrr.io/pkg/shiny/man/testServer.html" class="external-link">shiny::testServer()</a></code> works, we reccommend you see <a href="https://shiny.posit.co/r/articles/improve/server-function-testing/" class="external-link">this</a> article in the official Shiny docs.</p>
<section class="level2"><h2 id="common-test-cases">Common test cases<a class="anchor" aria-label="anchor" href="#common-test-cases"></a>
</h2>
<section class="level4"><h4 id="test-class-of-object">Test class of object<a class="anchor" aria-label="anchor" href="#test-class-of-object"></a>
</h4>
<p>Before interacting with a block, it is often a good idea to test that the block constructor has worked as intended and created the correct class of object. For this example, let’s create a pretend “test_block” class:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">test_that</span><span class="op">(</span><span class="st">"block constructor"</span>, <span class="op">{</span></span>
<span>    <span class="fu">expect_s3_class</span><span class="op">(</span><span class="fu">new_test_block</span><span class="op">(</span><span class="op">)</span>, <span class="st">"test_block"</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
</div>
</section><section class="level4"><h4 id="test-input-widgets-work">Test input widgets work<a class="anchor" aria-label="anchor" href="#test-input-widgets-work"></a>
</h4>
<p>Next, you may want to test that the input widgets to your block work as intended. That is, that changes in inputs are reflected by changes in reactive values in the block. For this example, let’s imagine out test block has an input widget that allows the user to select a color:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">test_that</span><span class="op">(</span><span class="st">"test block server input widgets update reactive values"</span>, <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/testServer.html" class="external-link">testServer</a></span><span class="op">(</span></span>
<span>        app <span class="op">=</span> <span class="fu">new_test_block</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="va">expr_server</span>, <span class="co"># Capture the expression server</span></span>
<span>        expr <span class="op">=</span> <span class="op">{</span></span>
<span>            <span class="va">session</span><span class="op">$</span><span class="fu">setInputs</span><span class="op">(</span>color <span class="op">=</span> <span class="st">"green"</span><span class="op">)</span> <span class="co"># Set a color</span></span>
<span>            <span class="fu">expect_equal</span><span class="op">(</span><span class="fu">color</span><span class="op">(</span><span class="op">)</span>, <span class="st">"green"</span><span class="op">)</span></span>
<span></span>
<span>            <span class="va">session</span><span class="op">$</span><span class="fu">setInputs</span><span class="op">(</span>color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="co"># Change color</span></span>
<span>            <span class="fu">expect_equal</span><span class="op">(</span><span class="fu">color</span><span class="op">(</span><span class="op">)</span>, <span class="st">"red"</span><span class="op">)</span></span>
<span>        <span class="op">}</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
</div>
</section><section class="level4"><h4 id="test-that-state-is-correctly-returned">Test that state is correctly returned<a class="anchor" aria-label="anchor" href="#test-that-state-is-correctly-returned"></a>
</h4>
<p>After confirming our input widgets work as expected, we may then want to check that the “state” of our block is returned correctly. Let’s expand our previous example to add a second input widget, number, which allows the user to select a numeric value. Here we access the state returned by our block by indexing into the <code>session$returned</code> object returned by <code><a href="https://rdrr.io/pkg/shiny/man/testServer.html" class="external-link">shiny::testServer()</a></code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">test_that</span><span class="op">(</span><span class="st">"state is correctly returned"</span>, <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/testServer.html" class="external-link">testServer</a></span><span class="op">(</span></span>
<span>        app <span class="op">=</span> <span class="fu">new_test_block</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="va">expr_server</span>,</span>
<span>        expr <span class="op">=</span> <span class="op">{</span></span>
<span>            <span class="co"># First check default values</span></span>
<span>            <span class="fu">expect_equal</span><span class="op">(</span><span class="va">session</span><span class="op">$</span><span class="va">returned</span><span class="op">$</span><span class="va">state</span><span class="op">$</span><span class="fu">number</span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>            <span class="fu">expect_equal</span><span class="op">(</span><span class="va">session</span><span class="op">$</span><span class="va">returned</span><span class="op">$</span><span class="va">state</span><span class="op">$</span><span class="fu">color</span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">character</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>            <span class="co"># Then toggle the inputs and recheck state is updated correctly</span></span>
<span>            <span class="va">session</span><span class="op">$</span><span class="fu">setInputs</span><span class="op">(</span>number <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>            <span class="fu">expect_equal</span><span class="op">(</span><span class="va">session</span><span class="op">$</span><span class="va">returned</span><span class="op">$</span><span class="va">state</span><span class="op">$</span><span class="fu">number</span><span class="op">(</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>            <span class="va">session</span><span class="op">$</span><span class="fu">setInputs</span><span class="op">(</span>color <span class="op">=</span> <span class="st">"pink"</span><span class="op">)</span></span>
<span>            <span class="fu">expect_equal</span><span class="op">(</span><span class="va">session</span><span class="op">$</span><span class="va">returned</span><span class="op">$</span><span class="va">state</span><span class="op">$</span><span class="fu">color</span><span class="op">(</span><span class="op">)</span>, <span class="st">"pink"</span><span class="op">)</span></span>
<span>        <span class="op">}</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
</div>
</section><section class="level4"><h4 id="test-that-expressions-are-correctly-returned">Test that expressions are correctly returned<a class="anchor" aria-label="anchor" href="#test-that-expressions-are-correctly-returned"></a>
</h4>
<p>In addition to checking the “state” returned by our block, we can also check that the “expr” is correctly evaluated. To evaluate our expressions, we can call <code><a href="https://rdrr.io/r/base/eval.html" class="external-link">base::eval()</a></code> on our returned expression, and then check that this evaluated expressions matches our expression. In this example, let’s assume that our input widgets combine in an expression to build a new “colored_number” class which just prints a colored number to the screen:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">test_that</span><span class="op">(</span><span class="st">"expr evaluates correctly"</span>, <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/testServer.html" class="external-link">testServer</a></span><span class="op">(</span></span>
<span>        app <span class="op">=</span> <span class="fu">new_test_block</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="va">expr_server</span>,</span>
<span>        expr <span class="op">=</span> <span class="op">{</span></span>
<span>            <span class="va">session</span><span class="op">$</span><span class="fu">setInputs</span><span class="op">(</span>number <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>            <span class="va">session</span><span class="op">$</span><span class="fu">setInputs</span><span class="op">(</span>color <span class="op">=</span> <span class="st">"cyan"</span><span class="op">)</span></span>
<span></span>
<span>            <span class="co"># Call `base::eval()` on our expression</span></span>
<span>            <span class="va">evaluated_expr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/eval.html" class="external-link">eval</a></span><span class="op">(</span><span class="va">session</span><span class="op">$</span><span class="va">returned</span><span class="op">$</span><span class="fu">expr</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>            <span class="fu">expect_s3_class</span><span class="op">(</span><span class="va">evaluated_expr</span>, <span class="st">"colored_number"</span><span class="op">)</span></span>
<span>        <span class="op">}</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
</div>
</section><section class="level4"><h4 id="test-that-expressions-correctly-throw-errors">Test that expressions correctly throw errors<a class="anchor" aria-label="anchor" href="#test-that-expressions-correctly-throw-errors"></a>
</h4>
<p>We may also want to test that errors are correctly thrown for incorrect expressions:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">test_that</span><span class="op">(</span><span class="st">"incorrect colours throw an error"</span>, <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/testServer.html" class="external-link">testServer</a></span><span class="op">(</span></span>
<span>        app <span class="op">=</span> <span class="fu">new_test_block</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="va">expr_server</span>,</span>
<span>        expr <span class="op">=</span> <span class="op">{</span></span>
<span>            <span class="va">session</span><span class="op">$</span><span class="fu">setInputs</span><span class="op">(</span>number <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span>            <span class="co"># Set invalid colour</span></span>
<span>            <span class="va">session</span><span class="op">$</span><span class="fu">setInputs</span><span class="op">(</span>color <span class="op">=</span> <span class="st">"Ooops"</span><span class="op">)</span></span>
<span></span>
<span>            <span class="co"># Check that an error is thrown</span></span>
<span>            <span class="fu">expect_error</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/eval.html" class="external-link">eval</a></span><span class="op">(</span><span class="va">session</span><span class="op">$</span><span class="va">returned</span><span class="op">$</span><span class="fu">expr</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>        <span class="op">}</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
</div>
</section><section class="level4"><h4 id="passing-additional-args">Passing additional args<a class="anchor" aria-label="anchor" href="#passing-additional-args"></a>
</h4>
<p>It is likely that some of your blocks require data or other blocks to be passed in as arguments to the block. To do this in our test suite, we can pass any such objects in a list to the <code>args</code> object of <code><a href="https://rdrr.io/pkg/shiny/man/testServer.html" class="external-link">testServer()</a></code>. For instance, let’s assume our test block requires a data.frame to be passed to the argument “df”:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">test_that</span><span class="op">(</span><span class="st">"test block server input widgets update reactive values"</span>, <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/testServer.html" class="external-link">testServer</a></span><span class="op">(</span></span>
<span>        app <span class="op">=</span> <span class="fu">new_test_block</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="va">expr_server</span>,</span>
<span>        <span class="co"># Set block arguments with the "args" argument</span></span>
<span>        args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>df <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/reactive.html" class="external-link">reactive</a></span><span class="op">(</span><span class="fu">gt</span><span class="fu">::</span><span class="fu">gt</span><span class="op">(</span><span class="va">mtcars</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        expr <span class="op">=</span> <span class="op">{</span></span>
<span>            <span class="va">session</span><span class="op">$</span><span class="fu">setInputs</span><span class="op">(</span>color <span class="op">=</span> <span class="st">"green"</span><span class="op">)</span></span>
<span>            <span class="fu">expect_equal</span><span class="op">(</span><span class="fu">color</span><span class="op">(</span><span class="op">)</span>, <span class="st">"green"</span><span class="op">)</span></span>
<span>        <span class="op">}</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
</div>
</section></section><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'light-border',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config);
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script></main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Nicolas Bennett, David Granjon, Christoph Sax.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
